<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FlowTime ‚Äî Calendar</title>
<style>
  body{font-family:'Poppins',sans-serif;background:#f0f4f8;margin:0;padding:0}
  header{background:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .btn{background:#6c4ab6;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
  h1{color:#6c4ab6;margin:0}
  .wrap{max-width:1100px;margin:22px auto;padding:0 18px;display:grid;grid-template-columns:1fr 360px;gap:20px}
  .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:12px}
  .day{background:#f7f7f7;padding:14px;border-radius:10px;min-height:80px;position:relative;cursor:pointer}
  .badges{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:6px;flex-wrap:wrap}
  .badge{background:#e8f0ff;border-radius:10px;padding:4px 8px;font-size:12px}
  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center}
  .modal{width:360px;background:#fff;padding:14px;border-radius:10px}
  .step-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .step-row input{padding:8px;border-radius:8px;border:1px solid #ddd}
</style>
</head>
<body>

<header>
  <a class="btn" href="index.html">üè† Home</a>
  <h1>üìÖ FlowTime Calendar</h1>
  <a class="btn" href="routines.html">Routines</a>
</header>

<div class="wrap">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;align-items:center">
        <select id="monthSelect"></select>
        <select id="yearSelect"></select>
        <div id="monthTitle" style="color:#555"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="goToday()">Today</button>
        <button onclick="openCreateModal()">Create Routine</button>
      </div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>
  </div>

  <div class="card">
    <h3 id="selectedDateLabel">Select a day</h3>
    <label><strong>Add a routine (existing):</strong></label>
    <select id="routineSelect" style="margin-top:8px"><option value="">-- select routine --</option></select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="assignSelectedRoutine()">Add to Day</button>
      <button onclick="openCreateModal()">Create</button>
    </div>
    <h4 style="margin-top:12px">Routines on this day</h4>
    <div id="dayRoutines"></div>
  </div>
</div>

<!-- Modal for create/edit -->
<div id="modal" class="modal-backdrop">
  <div class="modal" id="modalContent">
    <h3 id="modalTitle">New Routine</h3>
    <input id="modalRoutineName" placeholder="Routine name" style="width:100%;margin-bottom:8px;padding:8px;border-radius:8px;border:1px solid #ddd" />
    <div id="modalSteps"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="addModalStep()">+ Step</button>
      <button onclick="clearModal()">Clear</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="saveModalRoutine()">Save Routine</button>
      <button onclick="saveAndAssignFromModal()">Save & Assign to Selected Day</button>
      <button onclick="closeModal()" style="background:#ddd">Cancel</button>
    </div>
  </div>
</div>

<script>
/* Same data format as index.html & routines.html */
function uid(){return Date.now()+Math.floor(Math.random()*1000)}
function pad(n){return n<10?'0'+n:n}
function escapeHtml(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}

/* Month/Year selectors */
const monthSelect = document.getElementById('monthSelect');
const yearSelect = document.getElementById('yearSelect');
(function initSelectors(){
  for(let m=0;m<12;m++) monthSelect.appendChild(new Option(new Date(0,m).toLocaleString('default',{month:'long'}), m));
  const now = new Date();
  for(let y=2023;y<=2035;y++) yearSelect.appendChild(new Option(y,y));
  monthSelect.value = now.getMonth(); yearSelect.value = now.getFullYear();
})();

monthSelect.onchange = renderCalendar; yearSelect.onchange = renderCalendar;

function renderCalendar(){
  const month = Number(monthSelect.value), year = Number(yearSelect.value);
  document.getElementById('monthTitle').innerText = `${new Date(year,month).toLocaleString('default',{month:'long'})} ${year}`;
  const grid = document.getElementById('calendarGrid'); grid.innerHTML='';
  const firstDay = new Date(year,month,1), daysInMonth = new Date(year,month+1,0).getDate();
  for(let i=0;i<firstDay.getDay();i++) grid.appendChild(document.createElement('div'));
  const cd = JSON.parse(localStorage.getItem('calendarData')||'{}');
  const routines = JSON.parse(localStorage.getItem('routines')||'[]');
  for(let d=1;d<=daysInMonth;d++){
    const key = `${year}-${month+1}-${d}`;
    const div = document.createElement('div'); div.className='day'; div.dataset.key=key; div.onclick=()=>selectDay(key);
    div.innerHTML = `<div style="font-weight:600">${d}</div><div class="badges"></div>`;
    const ids = cd[key] || [];
    const badgeContainer = div.querySelector('.badges');
    ids.slice(0,3).forEach(id=>{
      const r = routines.find(x=>x.id===id);
      if(r){ const b = document.createElement('div'); b.className='badge'; b.textContent=r.name; badgeContainer.appendChild(b); }
    });
    if(ids.length>3){ const more=document.createElement('div'); more.className='badge'; more.textContent=`+${ids.length-3} more`; badgeContainer.appendChild(more); }
    grid.appendChild(div);
  }
  clearSelected();
  populateRoutineDropdown();
}

/* Selection & day routines */
let selectedKey = null;
function selectDay(key){
  selectedKey = key; document.getElementById('selectedDateLabel').innerText = 'Selected: '+key;
  document.querySelectorAll('.day').forEach(el=>el.style.outline='');
  const el = document.querySelector(`.day[data-key="${key}"]`); if(el) el.style.outline='3px solid rgba(108,74,182,0.15)';
  displayRoutinesForDay();
}
function clearSelected(){ selectedKey=null; document.getElementById('selectedDateLabel').innerText='Select a day'; document.getElementById('dayRoutines').innerHTML=''; }

function populateRoutineDropdown(){
  const dropdown = document.getElementById('routineSelect'); dropdown.innerHTML = '<option value="">-- select routine --</option>';
  const routines = JSON.parse(localStorage.getItem('routines')||'[]');
  routines.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent = `${r.name} (${r.totalTime} min)`; dropdown.appendChild(o); });
}

function assignSelectedRoutine(){
  if(!selectedKey) return alert('Choose a day first');
  const rid = Number(document.getElementById('routineSelect').value);
  if(!rid) return alert('Choose a routine');
  let cd = JSON.parse(localStorage.getItem('calendarData')||'{}');
  if(!cd[selectedKey]) cd[selectedKey]=[];
  cd[selectedKey].push(rid); cd[selectedKey] = Array.from(new Set(cd[selectedKey]));
  localStorage.setItem('calendarData', JSON.stringify(cd));
  renderCalendar(); displayRoutinesForDay();
}
function displayRoutinesForDay(){
  const container = document.getElementById('dayRoutines'); container.innerHTML='';
  if(!selectedKey) return;
  const cd = JSON.parse(localStorage.getItem('calendarData')||'{}'); const ids = cd[selectedKey]||[];
  const routines = JSON.parse(localStorage.getItem('routines')||'[]');
  if(ids.length===0){ container.innerHTML = '<div style="color:#777">No routines assigned</div>'; return; }
  ids.forEach(id=>{
    const r = routines.find(x=>x.id===id); if(!r) return;
    const box = document.createElement('div'); box.style.marginBottom='8px'; box.style.padding='8px'; box.style.background='#f0f4ff'; box.style.borderRadius='8px';
    box.innerHTML = `<strong>${escapeHtml(r.name)}</strong><div style="font-size:13px;color:#555">${r.totalTime} min ‚Ä¢ ${r.steps.length} steps</div>`;
    const btns = document.createElement('div'); btns.style.marginTop='8px'; btns.style.display='flex'; btns.style.gap='8px';
    const btnEdit = document.createElement('button'); btnEdit.textContent='Edit'; btnEdit.onclick = ()=> openModalForEdit(r.id);
    const btnRemove = document.createElement('button'); btnRemove.textContent='Remove'; btnRemove.onclick = ()=>{
      if(!confirm('Remove this routine from the day?')) return;
      const cd2 = JSON.parse(localStorage.getItem('calendarData')||'{}');
      cd2[selectedKey] = (cd2[selectedKey]||[]).filter(x=>x!==id); localStorage.setItem('calendarData', JSON.stringify(cd2));
      displayRoutinesForDay(); renderCalendar();
    };
    btns.appendChild(btnEdit); btns.appendChild(btnRemove); box.appendChild(btns); container.appendChild(box);
  });
}

/* Today helper */
function goToday(){ const now=new Date(); monthSelect.value=now.getMonth(); yearSelect.value=now.getFullYear(); renderCalendar(); const key=`${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`; selectDay(key); }

/* Modal create/edit */
const modal = document.getElementById('modal'); const modalTitle = document.getElementById('modalTitle'); const modalName = document.getElementById('modalRoutineName'); const modalSteps = document.getElementById('modalSteps'); let modalEditingId = null;

function openCreateModal(){ modalEditingId=null; modalTitle.innerText='Create Routine'; modalName.value=''; modalSteps.innerHTML=''; addModalStep(); showModal(); }
function openModalForEdit(rid){
  const routines = JSON.parse(localStorage.getItem('routines')||'[]'); const r = routines.find(x=>x.id===rid);
  if(!r) return alert('Routine not found'); modalEditingId = r.id; modalTitle.innerText='Edit Routine'; modalName.value = r.name; modalSteps.innerHTML=''; r.steps.forEach(s=> addModalStep(s)); showModal();
}
function showModal(){ modal.style.display='flex'; }
function closeModal(){ modal.style.display='none'; clearModal(); }
function addModalStep(step={id:uid(),name:'',time:''}){ const row=document.createElement('div'); row.className='step-row'; row.dataset.stepId=step.id; row.innerHTML = `<input class="step-name" placeholder="Step name" value="${escapeHtml(step.name)}"/><input class="step-time" type="number" placeholder="min" value="${step.time||''}" style="width:80px"/><button onclick="this.parentElement.remove()">üóë</button>`; modalSteps.appendChild(row); }
function clearModal(){ modalEditingId=null; modalName.value=''; modalSteps.innerHTML=''; }
function saveModalRoutine(){
  const name = modalName.value.trim(); if(!name) return alert('Enter name');
  const rows = Array.from(modalSteps.querySelectorAll('.step-row'));
  const steps = rows.map(r=>({ id: r.dataset.stepId||uid(), name: r.querySelector('.step-name').value.trim(), time: Number(r.querySelector('.step-time').value)||0 })).filter(s=>s.name);
  const total = steps.reduce((a,b)=>a+(b.time||0),0);
  let routines = JSON.parse(localStorage.getItem('routines')||'[]');
  if(modalEditingId) routines = routines.map(x=> x.id===modalEditingId ? {...x, name, steps, totalTime: total} : x);
  else routines.push({ id: uid(), name, steps, totalTime: total, pinned:false });
  localStorage.setItem('routines', JSON.stringify(routines)); populateRoutineDropdown(); renderCalendar(); closeModal();
}
function saveAndAssignFromModal(){ saveModalRoutine(); const routines = JSON.parse(localStorage.getItem('routines')||'[]'); const r = modalEditingId ? routines.find(x=>x.id===modalEditingId) : routines[routines.length-1]; if(!r) return alert('Could not find routine'); if(!selectedKey) return alert('Select a day first'); let cd = JSON.parse(localStorage.getItem('calendarData')||'{}'); if(!cd[selectedKey]) cd[selectedKey]=[]; cd[selectedKey].push(r.id); cd[selectedKey] = Array.from(new Set(cd[selectedKey])); localStorage.setItem('calendarData', JSON.stringify(cd)); renderCalendar(); displayRoutinesForDay(); closeModal(); }

/* Populate dropdown */
function populateRoutineDropdown(){ const dd = document.getElementById('routineSelect'); dd.innerHTML = '<option value="">-- select routine --</option>'; const r = JSON.parse(localStorage.getItem('routines')||'[]'); r.forEach(it=>{ const o=document.createElement('option'); o.value=it.id; o.textContent = `${it.name} (${it.totalTime} min)`; dd.appendChild(o); }); }

/* Read URL params for auto actions:
   - ?select=YYYY-M-D  -> select that day
   - ?openAssign=<id>  -> open modal and preselect routine to assign (we'll open modal for assignment)
   - If both present: select day, then open modal with assign routine prefilled
*/
function readUrlActions(){
  const params = new URLSearchParams(location.search);
  const select = params.get('select');
  const openAssign = params.get('openAssign');
  if(select){
    // wait a beat for render then select
    setTimeout(()=> selectDay(select), 200);
    if(openAssign){
      // open modal for editing that routine and leave selected day
      setTimeout(()=> openModalForEdit(Number(openAssign)), 500);
    }
  }
}

/* Init */
(function init(){
  populateRoutineDropdown(); renderCalendar(); readUrlActions();
})();
</script>
</body>
</html>
