<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FlowTime ‚Äî Calendar</title>
<style>
  :root{
    --accent-1:#FFBFD8; --accent-2:#FFD6A5; --accent-3:#CAFFBF; --muted:#6b556b;
    --bg:#fff7f9;
  }
  *{box-sizing:border-box}
  body{font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#fff9fb,#fff7f9);margin:0;color:#3a2b3a}
  header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px}
  .brand {display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-size:28px}
  .nav a{margin-left:8px;text-decoration:none;padding:8px 12px;border-radius:12px;background:linear-gradient(90deg,var(--accent-2),var(--accent-3));color:#422}
  .wrap{max-width:1100px;margin:14px auto;padding:0 18px;display:grid;grid-template-columns:1fr 360px;gap:20px}
  @media(max-width:1000px){ .wrap{ grid-template-columns:1fr } }
  .card{background:#fff;padding:16px;border-radius:18px;box-shadow:0 10px 28px rgba(170,120,170,0.06)}
  .controls{display:flex;gap:8px;align-items:center}
  select,button,input{padding:8px;border-radius:10px;border:1px solid #eee;font:inherit}
  .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:12px}
  .day{background:linear-gradient(180deg,#fff,#fffaf7);padding:12px;border-radius:12px;min-height:84px;position:relative;cursor:pointer}
  .day .num{font-weight:800;color:#5a2b4a}
  .badges{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:6px;flex-wrap:wrap}
  .badge{padding:4px 8px;border-radius:999px;background:linear-gradient(90deg,var(--accent-2),var(--accent-3));font-size:12px}
  .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center}
  .modal{background:#fff;padding:16px;border-radius:14px;width:360px}
  .step-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .step-row input{padding:8px;border-radius:8px;border:1px solid #eee}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">üçì</div>
    <div>
      <div style="font-weight:800;color:#5a2b4a">FlowTime Calendar</div>
      <div style="font-size:12px;color:var(--muted)">schedule & assign routines</div>
    </div>
  </div>
  <div class="nav">
    <a href="index.html">Home</a>
    <a href="routines.html">Routines</a>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;align-items:center">
        <select id="monthSelect"></select>
        <select id="yearSelect"></select>
        <div id="monthTitle" style="color:var(--muted);font-weight:700;margin-left:6px"></div>
      </div>
      <div class="controls">
        <button onclick="goToday()">Today</button>
        <button onclick="openCreateModal()">‚ûï Create Routine</button>
      </div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>
  </section>

  <aside class="card">
    <h3 id="selectedDateLabel">Select a day</h3>
    <label><strong>Add an existing routine</strong></label>
    <select id="routineSelect" style="margin-top:8px"></select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="assignSelectedRoutine()">Add to Day</button>
      <button onclick="openCreateModal()">Create</button>
    </div>
    <h4 style="margin-top:12px">Routines on this day</h4>
    <div id="dayRoutines"></div>
  </aside>
</main>

<!-- Modal: create/edit -->
<div id="modal" class="modal-backdrop">
  <div class="modal" id="modalContent">
    <h3 id="modalTitle">New Routine</h3>
    <input id="modalName" placeholder="Routine name" style="width:100%;margin-bottom:8px;padding:8px;border-radius:8px;border:1px solid #eee" />
    <div id="modalSteps"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="addModalStep()">+ Step</button>
      <button onclick="clearModal()">Clear</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="saveModalRoutine()">Save</button>
      <button onclick="saveAndAssignFromModal()">Save & Assign</button>
      <button onclick="closeModal()" style="background:#eee">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const pad = n => n<10?'0'+n:n;
const monthSelect = document.getElementById('monthSelect'), yearSelect = document.getElementById('yearSelect');
function uid(){ return Date.now()+Math.floor(Math.random()*1000) }
function isoKeyFromParts(y,m,d){ return `${y}-${m}-${d}` }
function getRoutines(){ return JSON.parse(localStorage.getItem('routines')||'[]') }
function getCalendar(){ return JSON.parse(localStorage.getItem('calendarData')||'{}') }
function setRoutines(arr){ localStorage.setItem('routines', JSON.stringify(arr)); localStorage.setItem('flowtime_sync', Date.now()); }
function setCalendar(obj){ localStorage.setItem('calendarData', JSON.stringify(obj)); localStorage.setItem('flowtime_sync', Date.now()); }

/* ---------- selectors init ---------- */
(function initSelectors(){
  for(let m=0;m<12;m++){ monthSelect.appendChild(new Option(new Date(0,m).toLocaleString('default',{month:'long'}), m)); }
  const now = new Date();
  for(let y=2023;y<=2035;y++) yearSelect.appendChild(new Option(y,y));
  monthSelect.value = now.getMonth(); yearSelect.value = now.getFullYear();
})();

monthSelect.onchange = renderCalendar; yearSelect.onchange = renderCalendar;

/* ---------- Calendar rendering (dynamic) ---------- */
function renderCalendar(){
  const month = Number(monthSelect.value), year = Number(yearSelect.value);
  document.getElementById('monthTitle').innerText = ` ${new Date(year,month).toLocaleString('default',{month:'long'})} ${year}`;
  const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
  const firstDay = new Date(year,month,1), daysInMonth = new Date(year,month+1,0).getDate();
  for(let i=0;i<firstDay.getDay();i++) grid.appendChild(document.createElement('div'));
  const cd = getCalendar(), routines = getRoutines();
  for(let d=1; d<=daysInMonth; d++){
    const key = isoKeyFromParts(year, month+1, d);
    const card = document.createElement('div'); card.className='day'; card.dataset.key = key;
    card.onclick = ()=> selectDay(key);
    card.innerHTML = `<div class="num">${d}</div><div class="badges"></div>`;
    const ids = cd[key] || [];
    const bc = card.querySelector('.badges');
    ids.slice(0,3).forEach(id => {
      const r = routines.find(x=>x.id===id); if(r){ const b = document.createElement('div'); b.className='badge'; b.textContent = r.name; bc.appendChild(b); }
    });
    if(ids.length > 3){ const more = document.createElement('div'); more.className='badge'; more.textContent = `+${ids.length-3} more`; bc.appendChild(more); }
    grid.appendChild(card);
  }
  clearSelected();
  populateRoutineDropdown();
}

/* selection + display */
let selectedKey = null;
function selectDay(key){
  selectedKey = key;
  document.getElementById('selectedDateLabel').innerText = `Selected: ${key}`;
  document.querySelectorAll('.day').forEach(el=>el.style.outline='');
  const el = document.querySelector(`.day[data-key="${key}"]`); if(el) el.style.outline = '3px solid rgba(170,120,170,0.12)';
  displayRoutinesForDay();
}
function clearSelected(){ selectedKey = null; document.getElementById('selectedDateLabel').innerText = 'Select a day'; document.getElementById('dayRoutines').innerHTML = ''; }

/* populate dropdown */
function populateRoutineDropdown(){
  const dd = document.getElementById('routineSelect'); dd.innerHTML = '<option value="">-- select routine --</option>';
  getRoutines().forEach(r => {
    const o = document.createElement('option'); o.value = r.id; o.textContent = `${r.name} (${r.totalTime} min)`; dd.appendChild(o);
  });
}

/* assign */
function assignSelectedRoutine(){
  if(!selectedKey) return alert('Choose a day first');
  const id = Number(document.getElementById('routineSelect').value); if(!id) return alert('Choose a routine');
  const cd = getCalendar(); if(!cd[selectedKey]) cd[selectedKey]=[]; cd[selectedKey].push(id); cd[selectedKey] = Array.from(new Set(cd[selectedKey])); setCalendar(cd); renderCalendar(); displayRoutinesForDay();
}

/* display for day */
function displayRoutinesForDay(){
  const box = document.getElementById('dayRoutines'); box.innerHTML = '';
  if(!selectedKey) return;
  const cd = getCalendar(), routines = getRoutines();
  const ids = cd[selectedKey] || [];
  if(ids.length === 0){ box.innerHTML = '<div style="color:#777">No routines</div>'; return; }
  ids.forEach(id => {
    const r = routines.find(x=>x.id===id); if(!r) return;
    const el = document.createElement('div'); el.style.padding='8px'; el.style.borderRadius='10px'; el.style.marginBottom='8px'; el.style.background='linear-gradient(180deg,#fff,#fffaf7)';
    el.innerHTML = `<div style="font-weight:800;color:#5a2b4a">${r.name}</div><div style="font-size:13px;color:var(--muted)">${r.totalTime} min ‚Ä¢ ${r.steps.length} steps</div>`;
    const actions = document.createElement('div'); actions.style.marginTop='8px'; actions.style.display='flex'; actions.style.gap='8px';
    const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick = ()=> openCreateModalForEdit(r.id);
    const remove = document.createElement('button'); remove.textContent='Remove'; remove.onclick = ()=> { if(!confirm('Remove from this day?')) return; const cd2 = getCalendar(); cd2[selectedKey] = cd2[selectedKey].filter(x=>x!==r.id); setCalendar(cd2); displayRoutinesForDay(); renderCalendar(); };
    actions.appendChild(edit); actions.appendChild(remove); el.appendChild(actions); box.appendChild(el);
  });
}

/* Today helper */
function goToday(){
  const now = new Date(); monthSelect.value = now.getMonth(); yearSelect.value = now.getFullYear(); renderCalendar();
  const key = isoKeyFromParts(now.getFullYear(), now.getMonth()+1, now.getDate());
  setTimeout(()=> selectDay(key), 100);
}

/* ---------- Modal create/edit ---------- */
const modal = document.getElementById('modal');
const modalName = document.getElementById('modalName'), modalSteps = document.getElementById('modalSteps'), modalTitle = document.getElementById('modalTitle');
let modalEditingId = null;

function openCreateModal(){ modalEditingId = null; modalTitle.innerText = 'Create Routine'; modalName.value=''; modalSteps.innerHTML=''; addModalStep(); showModal(); }
function openCreateModalForEdit(id){ openCreateModal(); setTimeout(()=> openCreateModalForEditSlow(id), 160); }
function openCreateModalForEditSlow(id){
  modalEditingId = id;
  const r = getRoutines().find(x=>x.id===id);
  if(!r) return;
  modalTitle.innerText = 'Edit Routine';
  modalName.value = r.name;
  modalSteps.innerHTML = '';
  r.steps.forEach(s => addModalStep(s));
  showModal();
}
function showModal(){ modal.style.display = 'flex'; }
function closeModal(){ modal.style.display = 'none'; clearModal(); }
function addModalStep(step={id:uid(), name:'', time:''}){ const row = document.createElement('div'); row.className='step-row'; row.dataset.id = step.id; row.innerHTML = `<input class="step-name" placeholder="Step name" value="${(step.name||'')}" /><input class="step-time" type="number" placeholder="min" value="${step.time||''}" style="width:90px"/><button onclick="this.parentElement.remove()">üóë</button>`; modalSteps.appendChild(row); }
function clearModal(){ modalEditingId = null; modalName.value=''; modalSteps.innerHTML=''; }
function saveModalRoutine(){
  const name = modalName.value.trim(); if(!name) return alert('Enter name');
  const rows = Array.from(modalSteps.querySelectorAll('.step-row'));
  const steps = rows.map(r => ({ id: r.dataset.id || uid(), name: r.querySelector('.step-name').value.trim(), time: Number(r.querySelector('.step-time').value)||0 })).filter(s=>s.name);
  const total = steps.reduce((a,b)=>a+(b.time||0), 0);
  let routines = getRoutines();
  if(modalEditingId){
    routines = routines.map(x => x.id === modalEditingId ? {...x, name, steps, totalTime: total} : x);
  } else {
    routines.push({ id: uid(), name, steps, totalTime: total, pinned:false });
  }
  setRoutines(routines);
  populateRoutineDropdown(); renderCalendar(); closeModal();
}
function saveAndAssignFromModal(){
  saveModalRoutine();
  const routines = getRoutines();
  const r = modalEditingId ? routines.find(x=>x.id===modalEditingId) : routines[routines.length-1];
  if(!r) return;
  if(!selectedKey) return alert('Please pick a day first');
  const cd = getCalendar(); if(!cd[selectedKey]) cd[selectedKey] = []; cd[selectedKey].push(r.id); cd[selectedKey] = Array.from(new Set(cd[selectedKey])); setCalendar(cd); renderCalendar(); displayRoutinesForDay(); closeModal();
}

/* quick open edit */
function openCreateModalForEdit(id){ modalEditingId = id; const r = getRoutines().find(x=>x.id===id); if(!r) return; modalTitle.innerText='Edit Routine'; modalName.value = r.name; modalSteps.innerHTML = ''; r.steps.forEach(s => addModalStep(s)); showModal(); }

/* assign from dropdown */
function assignSelectedRoutine(){
  if(!selectedKey) return alert('Choose a day');
  const id = Number(document.getElementById('routineSelect').value); if(!id) return alert('Choose routine');
  const cd = getCalendar(); if(!cd[selectedKey]) cd[selectedKey]=[]; cd[selectedKey].push(id); cd[selectedKey] = Array.from(new Set(cd[selectedKey])); setCalendar(cd); renderCalendar(); displayRoutinesForDay();
}

/* ---------- URL param support ---------- */
function readUrlActions(){
  const params = new URLSearchParams(location.search);
  const select = params.get('select');
  const openAssign = params.get('openAssign');
  const edit = params.get('edit');
  if(edit){ setTimeout(()=> openCreateModalForEdit(Number(edit)), 200); }
  if(select){
    setTimeout(()=> selectDay(select), 200);
    if(openAssign){ setTimeout(()=> { openCreateModalForEdit(Number(openAssign)); }, 500); }
  }
}

/* listen to storage event to update calendar in real-time */
window.addEventListener('storage', (e)=>{
  if(e.key === 'flowtime_sync') {
    // another tab changed data
    renderCalendar();
    // keep selected day details in sync
    if(selectedKey) displayRoutinesForDay();
    populateRoutineDropdown();
  }
});

/* init */
(function init(){
  populateRoutineDropdown();
  renderCalendar();
  readUrlActions();
})();
</script>
</body>
</html>
