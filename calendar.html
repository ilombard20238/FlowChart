<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowTime - Calendar</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 0;
    }

    header {
      background: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      margin: 0;
      color: #6c4ab6;
    }

    .calendar {
      max-width: 700px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .day {
      background: #f7f7f7;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
    }

    .day:hover {
      background: #e8e1f8;
    }

    .selected-day {
      background: #d5c8ff !important;
    }

    .side-panel {
      max-width: 700px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .routine-box {
      background: #f0f4ff;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 10px;
    }

    button {
      padding: 10px;
      border: none;
      background: #6c4ab6;
      color: white;
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
    }

    select {
      padding: 10px;
      width: 100%;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<header>
  <h1>ðŸ“… Your Calendar</h1>
</header>

<div class="calendar">
  <h2 id="monthTitle"></h2>
  <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div class="side-panel">
  <h3 id="selectedDateLabel">Select a day</h3>

  <label><strong>Add a Routine to this day:</strong></label>
  <select id="routineSelect">
    <option value="">-- Select Routine --</option>
  </select>

  <button onclick="assignRoutineToDay()">Add Routine</button>

  <h3>Routines on this day</h3>
  <div id="dayRoutines"></div>
</div>

<script>
  let selectedDay = null;

  function loadCalendar() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();

    const monthTitle = document.getElementById('monthTitle');
    const grid = document.getElementById('calendarGrid');

    monthTitle.innerText = now.toLocaleString('default', { month: 'long', year: 'numeric' });
    grid.innerHTML = "";

    const firstDay = new Date(year, month, 1);
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Fill blanks for first week
    for (let i = 0; i < firstDay.getDay(); i++) {
      const blank = document.createElement('div');
      grid.appendChild(blank);
    }

    // Add each day
    for (let day = 1; day <= daysInMonth; day++) {
      const div = document.createElement('div');
      div.className = "day";
      div.innerText = day;
      div.onclick = () => selectDay(year, month, day);

      grid.appendChild(div);
    }
  }

  function selectDay(year, month, day) {
    selectedDay = `${year}-${month + 1}-${day}`;
    document.getElementById("selectedDateLabel").innerText = "Selected: " + selectedDay;

    // clear highlight
    document.querySelectorAll('.day').forEach(d => d.classList.remove('selected-day'));

    // highlight selected
    const dayDivs = document.querySelectorAll('.day');
    dayDivs[day - 1].classList.add('selected-day');

    displayRoutinesForDay();
  }

  function loadRoutinesIntoDropdown() {
    const routines = JSON.parse(localStorage.getItem("routines") || "[]");
    const dropdown = document.getElementById("routineSelect");

    routines.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = `${r.name} (${r.totalTime} min)`;
      dropdown.appendChild(opt);
    });
  }

  function assignRoutineToDay() {
    if (!selectedDay) return alert("Choose a day first!");
    
    const routineId = document.getElementById("routineSelect").value;
    if (!routineId) return alert("Select a routine!");

    let calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}");

    if (!calendarData[selectedDay]) {
      calendarData[selectedDay] = [];
    }

    calendarData[selectedDay].push(Number(routineId));
    localStorage.setItem("calendarData", JSON.stringify(calendarData));

    displayRoutinesForDay();
  }

  function displayRoutinesForDay() {
    const dayBox = document.getElementById("dayRoutines");
    dayBox.innerHTML = "";

    if (!selectedDay) return;

    let routines = JSON.parse(localStorage.getItem("routines") || "[]");
    let calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}");

    const routineIds = calendarData[selectedDay] || [];

    routineIds.forEach(id => {
      const r = routines.find(x => x.id === id);
      if (r) {
        const div = document.createElement("div");
        div.className = "routine-box";
        div.innerHTML = `<strong>${r.name}</strong> - ${r.totalTime} min<br>(${r.steps.length} steps)`;
        dayBox.appendChild(div);
      }
    });
  }

  loadCalendar();
  loadRoutinesIntoDropdown();
</script>

</body>
</html>
