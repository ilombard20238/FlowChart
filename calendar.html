<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowTime - Calendar</title>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background:#f0f4f8;
      margin:0; padding:0;
    }

    header {
      background:#fff;
      padding:20px;
      text-align:center;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    header a {
      text-decoration:none;
      padding:10px 15px;
      background:#6c4ab6;
      color:white;
      border-radius:10px;
    }

    header h1 { margin:0; color:#6c4ab6; }

    .calendar {
      max-width:700px;
      margin:30px auto;
      background:#fff;
      padding:20px;
      border-radius:15px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:10px;
      margin-top:20px;
    }

    .day {
      background:#f7f7f7;
      padding:20px;
      border-radius:10px;
      text-align:center;
      cursor:pointer;
      transition:0.2s;
    }

    .day:hover { background:#e8e1f8; }
    .selected-day { background:#d5c8ff !important; }

    .side-panel {
      max-width:700px;
      margin:20px auto;
      background:white;
      padding:20px;
      border-radius:15px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
    }

    select, button {
      padding:10px;
      width:100%;
      border-radius:10px;
      margin-top:10px;
      border:1px solid #ccc;
      cursor:pointer;
    }

    .routine-box {
      background:#f0f4ff;
      padding:10px;
      border-radius:10px;
      margin-bottom:8px;
    }

    /* Popup */
    #popup {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      display:none;
      justify-content:center;
      align-items:center;
    }

    #popupContent {
      background:white;
      padding:20px;
      width:300px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.2);
    }

    #popupContent input {
      width:100%;
      padding:8px;
      margin-top:8px;
      border-radius:8px;
      border:1px solid #ccc;
    }

    #popupContent button {
      margin-top:10px;
    }

  </style>
</head>
<body>

<header>
  <a href="index.html">üè† Home</a>
  <h1>üìÖ Your Calendar</h1>
  <div></div>
</header>

<div class="calendar">
  <h2 id="monthTitle"></h2>

  <!-- Month + year selector -->
  <select id="monthSelect" onchange="updateCalendar()">
    <script>
      for (let m = 0; m < 12; m++) {
        document.write(`<option value="${m}">${new Date(0, m).toLocaleString('default', { month:'long' })}</option>`);
      }
    </script>
  </select>

  <select id="yearSelect" onchange="updateCalendar()">
    <script>
      for (let y = 2023; y <= 2035; y++) {
        document.write(`<option value="${y}">${y}</option>`);
      }
    </script>
  </select>

  <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div class="side-panel">
  <h3 id="selectedDateLabel">Select a day</h3>

  <label><strong>Add a Routine to this day:</strong></label>
  <select id="routineSelect">
    <option value="">-- Select Routine --</option>
  </select>

  <button onclick="assignRoutineToDay()">Add Routine</button>
  <button onclick="openPopup()">‚ûï Create New Routine</button>

  <h3>Routines on this day</h3>
  <div id="dayRoutines"></div>
</div>

<!-- POPUP FOR CREATING ROUTINE -->
<div id="popup">
  <div id="popupContent">
    <h3>New Routine</h3>
    <input type="text" id="newRoutineName" placeholder="Routine name">
    <input type="number" id="newRoutineTime" placeholder="Total minutes">
    <button onclick="saveNewRoutine()">Save</button>
    <button onclick="closePopup()">Cancel</button>
  </div>
</div>

<script>
  let selectedDay = null;

  function loadCalendar() {
    const now = new Date();
    document.getElementById("monthSelect").value = now.getMonth();
    document.getElementById("yearSelect").value = now.getFullYear();
    updateCalendar();
  }

  function updateCalendar() {
    const month = Number(document.getElementById("monthSelect").value);
    const year = Number(document.getElementById("yearSelect").value);

    const grid = document.getElementById("calendarGrid");
    const title = document.getElementById("monthTitle");

    title.innerText = `${new Date(year, month).toLocaleString('default', { month:'long' })} ${year}`;
    grid.innerHTML = "";

    const firstDay = new Date(year, month, 1);
    const daysInMonth = new Date(year, month+1, 0).getDate();

    for (let i = 0; i < firstDay.getDay(); i++) {
      grid.appendChild(document.createElement("div"));
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const d = document.createElement("div");
      d.className = "day";
      d.innerText = day;
      d.onclick = () => selectDay(year, month, day);
      grid.appendChild(d);
    }
  }

  function selectDay(year, month, day) {
    selectedDay = `${year}-${month+1}-${day}`;
    document.getElementById("selectedDateLabel").innerText = "Selected: " + selectedDay;

    document.querySelectorAll(".day").forEach(d => d.classList.remove("selected-day"));
    const allDays = document.querySelectorAll(".day");
    allDays[day - 1].classList.add("selected-day");

    displayRoutinesForDay();
  }

  function loadRoutinesDropdown() {
    const routines = JSON.parse(localStorage.getItem("routines") || "[]");
    const dropdown = document.getElementById("routineSelect");

    dropdown.innerHTML = `<option value="">-- Select Routine --</option>`;

    routines.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = `${r.name} (${r.totalTime} min)`;
      dropdown.appendChild(opt);
    });
  }

  function assignRoutineToDay() {
    if (!selectedDay) return alert("Choose a day");
    const routineId = document.getElementById("routineSelect").value;
    if (!routineId) return alert("Choose a routine");

    let calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}");
    if (!calendarData[selectedDay]) calendarData[selectedDay] = [];

    calendarData[selectedDay].push(Number(routineId));
    localStorage.setItem("calendarData", JSON.stringify(calendarData));

    displayRoutinesForDay();
  }

  function displayRoutinesForDay() {
    const box = document.getElementById("dayRoutines");
    box.innerHTML = "";
    if (!selectedDay) return;

    const routines = JSON.parse(localStorage.getItem("routines") || "[]");
    const calendarData = JSON.parse(localStorage.getItem("calendarData") || "{}");

    const ids = calendarData[selectedDay] || [];

    ids.forEach(id => {
      const r = routines.find(x => x.id === id);
      if (r) {
        const div = document.createElement("div");
        div.className = "routine-box";
        div.innerHTML = `<strong>${r.name}</strong> - ${r.totalTime} min`;
        box.appendChild(div);
      }
    });
  }

  // Popup controls
  function openPopup() {
    document.getElementById("popup").style.display = "flex";
  }
  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }

  function saveNewRoutine() {
    const name = document.getElementById("newRoutineName").value;
    const time = Number(document.getElementById("newRoutineTime").value);

    if (!name || !time) return alert("Fill all fields");

    const routine = {
      id: Date.now(),
      name,
      steps: [],
      totalTime: time,
      pinned: false
    };

    let routines = JSON.parse(localStorage.getItem("routines") || "[]");
    routines.push(routine);
    localStorage.setItem("routines", JSON.stringify(routines));

    closePopup();
    loadRoutinesDropdown();
    alert("Routine created!");

  }

  loadCalendar();
  loadRoutinesDropdown();
</script>

</body>
</html>
